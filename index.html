<!DOCTYPE html>
<html>
	<head>
		<title>Bullet Editor</title>
		<meta charset="utf-8" />

		<!-- bootstrap css -->
		<link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" />

		<!-- jquery js -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

		<!-- bootstrap js -->
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.bundle.min.js"></script>
		<script src="caret.js"></script>

		<!-- dictionary used for determining if a word is a past tense verb -->
		<script src="dictionary.js"></script>

		<!-- ALS style guide -->
		<script src="alsSG.js"></script>

		<!-- 480th ISRW style guide -->
		<script src="wingSG.js"></script>
		<!--<script src='https://code.jquery.com/jquery-3.1.0.min.js'></script>-->
	</head>
	<body>
		<div class="container">
			<div class="form-group">
				<h2>Bullet Software v.1.1</h2>
				<label for="bullet">Bullet:</label>
				<textarea id="bullet" class="form-control" rows="5"></textarea>
				<div id="grid" class="container">
					<div class="row">

						<!-- column that holds a dropdown for the bullet type and the character counter -->
						<div id="col1" class="col-sm">
							<div>

								<!-- dropdown for bullet type -->
								Bullet Type:<select id="type" class="drop">
									<option value="select">Select Type</option>
									<option value="epr">EPR</option>
									<option value="award">Award</option>
								</select>

								<!-- dropdown for style guide to be used for abbreviations -->
								Style Guide:<select id="sg" class="drop">
									<option value="select">Select Guide</option>
									<option value="als">ALS</option>
									<option value="480W">480th ISRW</option>
								</select>
								<br />
							</div>
						</div>

						<!-- column that holds the feedback for the user regarding the length of their bullet -->
						<div class="col-sm col2">
							<div>Length Check: <span id="lengthCheck">Select type</span></div>
							<br />
						</div>
					</div>
					<div class="row">
						<div class="col-sm">
							<p id="error"></p>
						</div>
						<div class="col-sm col2">
							<div><span id="wordCount">0</span> Characters</div>
						</div>
					</div>
				</div>
				<br />

				<!-- button panel -->
				<div class="btn-group d-flex" role="group">
					<button id="evaluate" class="btn btn-primary w-100" type="button">Evaluate</button>
					<button id="submitButton" class="btn btn-primary w-100" type="button">Submit</button>
				</div>

				<!-- bullet examples -->
				<!--<div class='bulletExamples'>
					<ul class='bulletExamples'>
					  <li>- Conducted 20 technical evals; ID'ed 10 trng shortfalls--sustained 98% up-time rate on $120M PACAF systems</li>
					  <li>- Conducted 168 insps/26 personal evals; ensured effective/safe mx practices across Gp--spt'd 25K fly hr pgm</li>
					  <li>- Participated w/sqdn Combat Dining In; helped set-up/tear down for event--fostered team work/esprit de corps</li>
					  <li>- True advocate of Team Moody; key member of base womens softball team...exemplifies whole person concept</li>
					</ul>
				</div>
				<button id="examplesButton" type="button" width="60px" height="100px">Bullet Examples</button>-->
			</div>
			
			<!-- container for "submitted" bullets -->
			<div class="submitClass"></div>
		</div>
	</body>
</html>
<style>
.bulletExamples {
	height: 125px;
	margin-top: 10px;
}
.drop{
	margin: 5px;
}
.col2 {
	text-align: right;
}
#grid {
	margin-top: 10px;
}
#evaluate {
	background-color: #0069d9;
}
#evaluate:hover {
	background-color: #024ebf;
}
#examplesButton {
	background-color: white;
	color: blue;
	border: 2px solid #FFFFFF; /* Green */
	text-align: left;
	margin: 4px 2px;
}
#examplesButton:hover {
	background-color: white;
	color: #1E90FF;
	border: 2px solid #FFFFFF; /* Green */
	text-align: left;
	margin: 4px 2px;
	cursor: pointer;
}
ul {
	list-style: none;
	padding: 0;
}
</style>
<script>
	// when the page is fully loaded, start running the code
	$(document).ready(function(){
		
		// defines variables for length checking
		var lengthCheck = $("#lengthCheck");
		var myText = $("#bullet");
		var wordCount = $("#wordCount");
		var characters = '';
		var dropType = $("#type");
		var dropSG = $("#sg");
		var lastSG,
		min,
		max;

		// variables for reverse abbreviation
		var caret,
		lastCaret,
		bullet,
		length;
		var abbrevs = [];
		var lastLength = 0;
		
		// notifies the user if their bullet is the proper length (within a min and max)
		function updateLengthCheck(){
			if (characters.length < min) {
				lengthCheck.text("Too short");
			} else if (characters.length <= max) {
				lengthCheck.text("Perfect");
			} else if (characters.length > max) {
				lengthCheck.text("Too long");
			} else {
				lengthCheck.text("Select type");
			}
		}

		// uses dictionary to determine if a word is a past tense verb or not
		function isVerb(word){
			var verb = false;
			var isTensed = false;
			var dict = Object.keys(dictionary);
			dict.forEach(function(term){
				if(Array.isArray(dictionary[term])){
					dictionary[term].forEach(function(altTerm, index){
						if(word.toLowerCase() == altTerm.toLowerCase()){
							if(index >= 2){
								isTensed = true;
							}
						}
					});
				}
			});
			return isTensed;
		}

		// unshortens -ed endings
		function lengthenEndings(bullet){
			bullet = bullet.replace(/\'d\b/gi, 'ed');
			return bullet;
		}
		
		// code that runs when the user selects a bullet type goes here
		dropType.on("change", function() {
			
			// changes min and max values for the length checker based on bullet type
			if (dropType.val() == "epr"){
				min = 113;
				max = 118;
			} else if (dropType.val() == "award") {
				min = 84;
				max = 140;
			} else {
				min = undefined;
				max = undefined;
			}
			updateLengthCheck();
		});

		// code that runs every time a key is pressed runs here
		myText.on("keyup", function(){

			// updates the character counter element to reflect the new length of the bullet
			characters = myText.val();
			wordCount.text(characters.length);
			updateLengthCheck();
		});

		// code that runs when the evaluate button is pressed goes here
		// this includes replacing words with abbreviations, checking that delimiters are present, etc
		$("#evaluate").click(function(){
			try {
				var bulletNew = myText.val();
				
				// auto-adds a "- " to the beginning of a bullet if one is not present
				var bulletNewArray = bulletNew.split("");
				if(bulletNew.trim().indexOf('-') !== 0) {
					bulletNew = "- " + bulletNew;
					myText.val(bulletNew);
				} else if (bulletNew.trim().indexOf('-') === 0 && bulletNewArray[1] !== " ") {
					bulletNew = bulletNewArray.shift();
					bulletNew = bulletNewArray.join();
					bulletNew = "- " + bulletNew;
					myText.val(bulletNew);
				}
				
				// lengthens -ed endings in the event of multiple evaluations in a row
				bulletNew = lengthenEndings(bulletNew);

				// unabbreviates bullet if its been abbreviated already (for the sake of making sure the first word in each section will be recognized as a valid word)
				//bulletNew = unabbreviate(bulletNew);

				// actual evaluation starts here
				// checks if the bullet starts with "- "
				if(bulletNew.indexOf('- ') === 0){

					// check for presence of 2 delimiters
					var bulletSections = bulletNew.split(/(?:;|--|\...)/);
					if (bulletSections.length !== 3) {
						throw new Error('Bullet must contain 2 semicolons, double-dashes, or elipses or some combination thereof.');
					} else {

						// splits bullet into 3 sections
						bulletSections[0] = bulletSections[0].slice(2, bulletSections[0].length);

						// checks that each section starts with a past tense verb
						bulletSections.forEach(function(section, index){
							section = section.trim();
							var firstWord = section.split(' ')[0];
							
							if(!isVerb(firstWord)){
								throw new Error('Each bullet section must start with a PAST TENSE VERB. Section #' + (index + 1) + ' does not.');
							}
						});
						$('#error').text('Good job!');
						$('#error').css('color', 'green');
					}
				} else {
					throw new Error('Bullet must start with "- ".');
				}

				// automatically replaces words with abbreviations
				if(dropSG.val() == "als"){
					console.log(bulletNew);
					var alsSGArray = Object.entries(alsSG);

					// loops through all words w/ abbreviations in the style guide
					// loops in reverse order to prevent unintended replacements of short words
					alsSGArray.reverse().forEach(function(alsSGEntry) {
						var indices = getIndicesOf(alsSGEntry[0], bulletNew, false);
						if(indices !== false){
							console.log(indices);

							indices.forEach(function(index){
								
								// adds indices to abbrevs
								abbrevs.push({
									index: index,
									word: alsSGEntry[0],
									abbrev: alsSGEntry[1]
								});

								abbrevs.forEach(function(abbreviation){
									
									// checks if other indices will be thrown off by this abbreviation
									if(abbreviation.index > index){

										// fix potential conflicts by subtracting the difference between the original word and the abbreviation
										abbreviation.index = abbreviation.index - (alsSGEntry[0].length - alsSGEntry[1].length);
									}
								});
							});
						}
						bulletNew = bulletNew.replace(new RegExp('\\b(?:' + alsSGEntry[0] + ')', 'gi'), alsSGEntry[1]);
						bulletNew = bulletNew.replace(new RegExp('\\b(?:' + (alsSGEntry[0] + 's') + ')', 'gi'), alsSGEntry[1] + 's');
					});
					myText.val(bulletNew);
					console.log(abbrevs);

					// sets the last study guide to ALS for unabbreviation purposes later
					lastSG = alsSG;
				} else if (dropSG.val() == "480W"){
					var wingSGArray = Object.entries(wingStyleGuide);
					wingSGArray.forEach(function(wingSGEntry) {
						bulletNew = bulletNew.replace(new RegExp('\\b(?:' + wingSGEntry[0] + ')', 'gi'), wingSGEntry[1]);
						bulletNew = bulletNew.replace(new RegExp('\\b(?:' + (wingSGEntry[0] + 's') + ')', 'gi'), wingSGEntry[1] + 's');
					});
					myText.val(bulletNew);

					// sets the last study guide to 480th ISRW for unabbreviation purposes later
					lastSG = wingStyleGuide;
				} else {
					throw new Error('Select style guide.');
				}
				
				// checks if all words in bullet are past tense verbs; if so, replaces -ed with -'d at the end to conserve space
				var wordArray = bulletNew.split(' ');
				for (i = 0; i < wordArray.length; i++) {
					if(isVerb(wordArray[i])) {
						wordArray[i] = wordArray[i].replace(/ed\b/gi, '\'d');
					}
				}
				
				// sets the bullet value to the bullet with altered endings
				myText.val(wordArray.join(' '));
			}
			catch(error){
				$('#error').text(error.message);
				$('#error').css('color', 'red');
			}
		});
		
		$("#submitButton").click(function(){	
			
			// cuts the bullet from the text box and pastes it down below so the user can type more bullets
			if (myText.val().trim().length !== 0) {
				$("body .submitClass").append('<br />' + myText.val().trim());
				textAreaNew = undefined;
				myText.val(textAreaNew);
			}
		});

		// unabbreviates all words in a string according to a study guide
		function unabbreviate(bullet){
			if(lastSG !== undefined){
				console.log(lastSG);

				// loops through studyGuide replacing all abbreviations w/ their respective words
				var styleGuideArray = Object.entries(lastSG);
				styleGuideArray.forEach(function(styleGuideEntry) {
					//bullet = bullet.replace(new RegExp('\\b(?:' + styleGuideEntry[1] + ')\\b', 'gi'), styleGuideEntry[0]);
					//bullet = bullet.replace(new RegExp('\\b(?:' + (styleGuideEntry[1] + 's') + ')\\b', 'gi'), styleGuideEntry[0] + 's');
					if(styleGuideEntry[1].length > 1){
						bullet = bullet.replace(new RegExp(styleGuideEntry[1], 'g'), styleGuideEntry[0]);
					}
				});
			}
			console.log(bullet);
			return bullet;
		}

		function getIndicesOf(searchStr, str, caseSensitive) {
			var searchStrLen = searchStr.length;
			if (searchStrLen == 0) {
				return false;
			}
			var startIndex = 0, index, indices = [];
			if (!caseSensitive) {
				str = str.toLowerCase();
				searchStr = searchStr.toLowerCase();
			}
			while ((index = str.indexOf(searchStr, startIndex)) > -1) {
				indices.push(index);
				startIndex = index + searchStrLen;
			}
			if(indices.length > 0){
				return indices;
			}
			else {
				return false;
			}
		}

		function updateCaret(){
			if($('#bullet').is(':focus')){

				//console.log('textbox caret: ' + $('#bullet').caret());
				//console.log('hl caret: ' + $('.hl').caret());
				caret = $('#bullet').caret();
			}
			else{
				caret = undefined;
			}
			console.log('caret: ' + caret);
		}

		$(document).on('mouseup', function(){
			updateCaret();

			// get selection

			lastCaret = caret;
		});

		$(document).on('keydown', function(){
			updateCaret();
			bullet = myText.val();
			console.log('length: ' + length);
			if(length === 0){
				abbrevs = [];
			}
			if(length !== bullet.length){
				length = bullet.length;

				// check if bullet changed
				if(length !== lastLength){
					// checks if abbreviations were altered; if so, they are removed; if not, they are updated

					var newAbbrevs = [];
					abbrevs.forEach(function(abbreviation){
						
						// updates index if they are typing in front of the current abbreviation
						if(caret < abbreviation.index){
							abbreviation.index++;
							newAbbrevs.push(abbreviation);
						}

						// does nothing if they are typing after all abbreviations
						else if(caret > (abbreviation.index + abbreviation.abbrev.length)){
							newAbbrevs.push(abbreviation);
						}
					});
					abbrevs = newAbbrevs;
				}

				lastLength = length;

				lastCaret = caret;

				console.log(abbrevs);
			}
		});
		
		//Hides examples of bullets
		/*$('.bulletExamples').hide();
		
		//Bullet Examples Button
		$("#examplesButton").click(function(){
			$('.bulletExamples').slideToggle(500,"linear");
		});*/
	});
</script>